<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Painel Admin - Gerenciar Usu√°rios</title>
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header>
            <h1 class="brandTitle">
                <img src="/logo-viasoft.png" alt="Viasoft" class="headerLogo" />
                Admin - <span>Gerenciamento de Usu√°rios</span>
            </h1>
            <div class="acoes">
                <button id="toggleTheme" class="btnGhost sm">üåô Tema Escuro</button>
                <a href="/dashboard" class="btnGhost sm">‚¨ÖÔ∏è Voltar</a>
                <a href="/logout" id="logoutBtn" class="btnGhost sm danger">üö™ Sair</a>
            </div>
        </header>

        <!-- Cadastro de Usu√°rio -->
        <section class="adminSection">
            <h2>‚ûï Cadastrar Usu√°rio</h2>
            <form id="formNovoUsuario" class="adminForm">
                <input type="text" id="novoUser" placeholder="Usu√°rio" required />
                <input type="password" id="novoPass" placeholder="Senha" required />
                <select id="novoTeam" required>
                    <option value="">Selecione a equipe...</option>
                    <!-- ‚ö° Lista de equipes gerada pelo JS -->
                </select>
                <select id="novoRole" required>
                    <option value="user">Usu√°rio</option>
                    <option value="admin">Admin</option>
                </select>
                <button type="submit" class="btnSalvar">‚úÖ Criar</button>
            </form>
        </section>

        <!-- Lista de Usu√°rios -->
        <section class="adminSection">
            <h2>üë§ Usu√°rios do Sistema</h2>
            <table class="adminTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usu√°rio</th>
                        <th>Equipe</th>
                        <th>Role</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </section>
    </div>

    <div class="appFooter">Desenvolvido para Viasoft ¬© 2025</div>

    <script>
        (async function () {
            const tbody = document.getElementById("usersTableBody");
            const formNovo = document.getElementById("formNovoUsuario");
            const selectTeam = document.getElementById("novoTeam");

            // ‚ö° Lista de equipes
            const EQUIPES = [
                "AD TECH NEGOCIOS LTDA", "Administradores", "Agente", "Agrotitan - Equipe Consultores",
                "Agrotitan - Equipe T√©cnica", "Agrotitan - L√≠deres", "Agrotitan - Suporte", "Agrotitan - Suporte Franquias",
                "Agrotitan Fazendas - Equipe T√©cnica", "Agrotitan Fazendas - Suporte", "Analytics - B.I", "Analytics - B.I - Suporte",
                "Assessoria Produto", "Aut. Comercial - L√≠deres", "Aut. Comercial - Suporte", "Aut. Comercial - Suporte Consultores",
                "Borges e Mazete - Suporte", "Cands - Suporte", "Clientes", "Comercial", "Conselho Diretor", "Construshow - Equipe T√©cnica",
                "Construshow - L√≠deres", "Construshow - Suporte", "Construshow - Suporte Franquias", "CRM - Equipe T√©cnica", "CRM - Suporte",
                "CRM - VX", "Financeiro - VIASOFT", "GCC - Gest√£o de Combate ao Churn", "GO UP -  Suporte", "Ifact", "Link - Suporte",
                "LZ - Suporte", "Melhorias Personalizadas - ENN", "Melhorias Personalizadas - Equipe de Analistas",
                "Melhorias Personalizadas - Equipe de Desenvolvimento", "Melhorias Personalizadas - Executivos de relacionamento",
                "Melhorias Personalizadas - L√≠deres", "MN Agrobusiness", "MP AGROTECH - Suporte", "Nimitz - Lideres", "Nimitz - Suporte",
                "Nimitz - VX", "Ouvidoria", "Petroshow - Equipe T√©cnica", "Petroshow - L√≠deres", "Petroshow - Suporte", "PRODACON - Consultores",
                "PRODACON - Suporte", "Servi√ßos Fiscais - Equipe T√©cnica", "Servi√ßos Fiscais - Suporte", "Servi√ßos Fiscais - Suporte Franquias",
                "TalentRH - Equipe T√©cnica", "TalentRH - L√≠deres", "TalentRH - Suporte", "TalentRH - Suporte Franquias", "VIASOFT - Canais",
                "VIASOFT - Comit√™ de IA", "VIASOFT - Controladoria", "VIASOFT - Facilities", "VIASOFT - FinOps", "VIASOFT - HOK", "VIASOFT - HOK LMS",
                "VIASOFT - Melhorias Personalizadas", "VIASOFT - Migra√ß√µes", "VIASOFT - Sistemas Internos", "VIASOFT - Suporte a Personaliza√ß√µes",
                "VIASOFT - Suporte Oracle Cloud", "VIASOFT - Support Leaders", "VIASOFT - Tecnologia", "Viasuper - Equipe T√©cnica", "Viasuper - L√≠deres",
                "Viasuper - Suporte", "VOORS  - Suporte", "VOORS - Equipe T√©cnica", "VOORS - VX", "VX - AGROTITAN", "VX - AGROTITAN FAZENDAS",
                "VX - CONSTRUSHOW", "VX - PETROSHOW"
            ];

            // Popular select de cadastro
            EQUIPES.forEach(eq => {
                const opt = document.createElement("option");
                opt.value = eq;
                opt.textContent = eq;
                selectTeam.appendChild(opt);
            });

            // Cadastro de novo usu√°rio
            formNovo.addEventListener("submit", async (e) => {
                e.preventDefault();
                const username = document.getElementById("novoUser").value;
                const password = document.getElementById("novoPass").value;
                const team = document.getElementById("novoTeam").value;
                const role = document.getElementById("novoRole").value;

                const res = await fetch("/admin/users/create", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password, team, role })
                });

                if (res.ok) {
                    alert("‚úÖ Usu√°rio criado!");
                    formNovo.reset();
                    carregarUsuarios();
                } else {
                    alert("‚ùå Erro ao criar usu√°rio");
                }
            });

            // Carregar usu√°rios
            async function carregarUsuarios() {
                tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
                try {
                    const resp = await fetch("/admin/users");
                    if (!resp.ok) { tbody.innerHTML = "<tr><td colspan='5'>Erro ao carregar</td></tr>"; return; }
                    const users = await resp.json();

                    tbody.innerHTML = "";
                    users.forEach(u => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td><select data-team>${EQUIPES.map(eq => `<option value="${eq}" ${u.team === eq ? "selected" : ""}>${eq}</option>`).join("")}</select></td>
                <td>
                  <select data-role>
                    <option value="user" ${u.role === "user" ? "selected" : ""}>Usu√°rio</option>
                    <option value="admin" ${u.role === "admin" ? "selected" : ""}>Admin</option>
                    <option value="inactive" ${u.role === "inactive" ? "selected" : ""}>Inativo</option>
                  </select>
                </td>
                <td>
                  <button class="btnSalvar">üíæ Salvar</button>
                  <button class="btnInativar">üö´ Inativar</button>
                  <button class="btnExcluir danger">üóë Excluir</button>
                </td>
              `;

                        // eventos
                        tr.querySelector(".btnSalvar").addEventListener("click", async () => {
                            const team = tr.querySelector("[data-team]").value;
                            const role = tr.querySelector("[data-role]").value;
                            const res = await fetch("/admin/users/update", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ userId: u.id, team, role })
                            });
                            alert(res.ok ? "‚úÖ Atualizado!" : "‚ùå Erro ao atualizar");
                        });

                        tr.querySelector(".btnInativar").addEventListener("click", async () => {
                            const res = await fetch("/admin/users/update", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ userId: u.id, role: "inactive", team: u.team })
                            });
                            alert(res.ok ? "üö´ Usu√°rio inativado!" : "‚ùå Erro ao inativar");
                            carregarUsuarios();
                        });

                        tr.querySelector(".btnExcluir").addEventListener("click", async () => {
                            if (!confirm("Tem certeza que deseja excluir o usu√°rio?")) return;
                            const res = await fetch("/admin/users/delete", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ userId: u.id })
                            });
                            alert(res.ok ? "üóë Usu√°rio exclu√≠do!" : "‚ùå Erro ao excluir");
                            carregarUsuarios();
                        });

                        tbody.appendChild(tr);
                    });
                } catch (err) {
                    tbody.innerHTML = "<tr><td colspan='5'>Erro ao conectar.</td></tr>";
                }
            }

            // Tema claro/escuro
            document.getElementById("toggleTheme").addEventListener("click", () => {
                document.body.classList.toggle("dark");
                document.getElementById("toggleTheme").textContent =
                    document.body.classList.contains("dark") ? "‚òÄÔ∏è Tema Claro" : "üåô Tema Escuro";
            });

            carregarUsuarios();
        })();
    </script>
</body>
</html>
