<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Painel Administrador</title>
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header>
            <h1 class="brandTitle">
                <img src="/logo-viasoft.png" alt="Viasoft" class="headerLogo" />
                Admin - <span>Painel Administrador</span>
            </h1>
            <div class="acoes">
                <button id="toggleTheme" class="btnGhost sm">üåô Tema Escuro</button>
                <a href="/reports" class="btnGhost sm">üìä Relat√≥rios</a>
                <a href="/dashboard" class="btnGhost sm">‚¨ÖÔ∏è Voltar</a>
                <a href="/logout" id="logoutBtn" class="btnGhost sm danger">üö™ Sair</a>
            </div>
        </header>
        <script>
        // Wrap icon + label so only icon shows when collapsed (Admin page)
        (function(){
          const actions = document.querySelector('.acoes'); if(!actions) return;
          function iconize(el){
            if(!el || el.dataset.iconized) return;
            const txt=(el.textContent||'').trim(); if(!txt) return;
            const sp=txt.indexOf(' '); const icon= sp>-1? txt.slice(0,sp):txt; const label= sp>-1? txt.slice(sp+1):'';
            el.innerHTML='';
            const i=document.createElement('span'); i.className='icon'; i.setAttribute('aria-hidden','true'); i.textContent=icon; el.appendChild(i);
            const L=document.createElement('span'); L.className='label'; L.textContent=label; el.appendChild(L);
            el.dataset.iconized='1';
          }
          function scan(){ actions.querySelectorAll('a.btnGhost.sm,button.btnGhost.sm').forEach(iconize); }
          scan();
          new MutationObserver(scan).observe(actions,{childList:true,subtree:true,characterData:true});
        })();
        </script>

        <!-- Cadastro de Usu√°rio -->
        <!-- Painel de Melhorias -->
        <section class="adminSection">
            <h2>üí° Controle de Melhorias</h2>
            <div style="display:flex;gap:18px;margin-bottom:18px;">
                <div class="cardWidget azul"><div class="cardInfo"><h3>Enviadas</h3><p id="melhoriasEnviadas">0</p></div></div>
                <div class="cardWidget laranja"><div class="cardInfo"><h3>Em An√°lise</h3><p id="melhoriasAnalise">0</p></div></div>
                <div class="cardWidget verde"><div class="cardInfo"><h3>Implementadas</h3><p id="melhoriasImpl">0</p></div></div>
                <div class="cardWidget vermelha"><div class="cardInfo"><h3>Rejeitadas</h3><p id="melhoriasRejeitadas">0</p></div></div>
            </div>
            <div class="adminSection" style="padding:0;box-shadow:none;">
                <h3 style="margin:10px 0 8px 8px;font-size:16px;font-weight:600;">üìù Lista de Sugest√µes</h3>
                <div id="listaMelhorias"></div>
            </div>
        </section>

        <!-- Cadastro de Usu√°rio com cards -->
        <section class="adminSection">
            <h2>‚ûï Cadastrar Usu√°rio</h2>
            <div style="display:flex;gap:18px;margin-bottom:18px;">
                <div class="cardWidget verde">
                    <div class="cardInfo">
                        <h3>Novo Usu√°rio</h3>
                        <form id="formNovoUsuario" class="adminForm" style="margin:0;">
                            <input type="text" id="novoUser" placeholder="Usu√°rio" required />
                            <input type="password" id="novoPass" placeholder="Senha" required />
                            <select id="novoTeam" required>
                                <option value="">Selecione a equipe...</option>
                                <!-- ‚ö° Lista de equipes gerada pelo JS -->
                            </select>
                            <select id="novoRole" required>
                                <option value="user">Agente</option>
                                <option value="admin">Admin</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Curador">Curador</option>
                                <option value="inactive">Inativo</option>
                                <option value="Support Leader">Lider Suporte</option>
                                <option value="TV">TV</option>
                                <option value="Gerente">Gerente</option>
        
                            </select>
                            <label style="display:flex;align-items:center;gap:8px;margin:6px 0 2px 2px;">
                                <input type="checkbox" id="novoMustChange" checked />
                                <span>Trocar senha no primeiro login</span>
                            </label>
                            <button type="submit" class="btnSalvar">‚úÖ Criar</button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Usu√°rios do Sistema com cards -->
        <section class="adminSection">
            <h2>üë§ Usu√°rios do Sistema</h2>
            <div style="display:flex;gap:18px;margin-bottom:18px;">
                <div class="cardWidget azul" style="flex:2;">
                    <div class="cardInfo">
                        <h3>Lista de Usu√°rios</h3>
                        <table class="adminTable" style="margin-top:10px;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usu√°rio</th>
                                    <th>Equipe</th>
                                    <th>Role</th>
                                    <th>Troca Senha</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div class="appFooter">Desenvolvido para Viasoft ¬© 2025</div>

    <script>
    (async function () {
            // Painel de melhorias
            async function carregarMelhorias() {
                const lista = document.getElementById("listaMelhorias");
                lista.innerHTML = "<p>Carregando...</p>";
                try {
                    const resp = await fetch("/api/melhorias");
                    if (!resp.ok) { lista.innerHTML = "<p>Erro ao carregar melhorias</p>"; return; }
                    const melhorias = await resp.json();
                    // Contadores
                    document.getElementById("melhoriasEnviadas").textContent = melhorias.filter(m=>m.status==="Enviada").length;
                    document.getElementById("melhoriasAnalise").textContent = melhorias.filter(m=>m.status==="Em An√°lise").length;
                    document.getElementById("melhoriasImpl").textContent = melhorias.filter(m=>m.status==="Implementada").length;
                    document.getElementById("melhoriasRejeitadas").textContent = melhorias.filter(m=>m.status==="Rejeitada").length;
                    // Cards
                    lista.innerHTML = "";
                    // Cards resumidos e melhorias rejeitadas
                    const melhoriasRejeitadas = melhorias.filter(m => m.status === "Rejeitada");
                    const melhoriasNormais = melhorias.filter(m => m.status !== "Rejeitada");
                    melhoriasNormais.slice().reverse().forEach(m => {
                        const card = document.createElement("div");
                        card.className = "ticket";
                        card.style.minHeight = "unset";
                        // Resumo: mostra s√≥ t√≠tulo, autor, status, data, bot√£o expandir
                        card.innerHTML = `
                            <h4>${m.titulo}</h4>
                            <div style=\"display:flex;justify-content:space-between;align-items:center;margin-top:8px;\">
                                <small>Enviado por: <b>${m.autor}</b></small>
                                <span style=\"font-size:13px;opacity:.8;\">${m.data}</span>
                            </div>
                            <div style=\"display:flex;gap:8px;margin-top:8px;\">
                                <span class=\"badge\" style=\"background:${m.status==="Enviada"?"#2563eb":m.status==="Em An√°lise"?"#f59e0b":m.status==="Implementada"?"#16a34a":"#888"};\">${m.status}</span>
                                ${m.status!=="Implementada" ? `<button class=\"btnSalvar\" data-status=\"Em An√°lise\">üîç Em An√°lise</button>` : ""}
                                ${m.status!=="Implementada" ? `<button class=\"btnSuccess\" data-status=\"Implementada\">‚úÖ Implementar</button>` : ""}
                                <button class=\"btnGhost\" data-expand>üîé Ler mais</button>
                                ${m.status!=="Rejeitada" ? `<button class=\"btnDanger\" data-status=\"Rejeitada\">üö´ Rejeitar</button>` : ""}
                            </div>
                            <div class=\"descricaoCompleta\" style=\"display:none;margin-top:8px;\">${m.descricao.replace(/\n/g,"<br>")}</div>
                        `;
                        // Expandir/ler mais
                        card.querySelector("[data-expand]").onclick = function() {
                            const desc = card.querySelector(".descricaoCompleta");
                            desc.style.display = desc.style.display === "none" ? "block" : "none";
                            this.textContent = desc.style.display === "none" ? "üîé Ler mais" : "üîΩ Ocultar";
                        };
                        // Bot√µes de status
                        card.querySelectorAll("button[data-status]").forEach(btn => {
                            btn.onclick = async () => {
                                const res = await fetch("/api/melhorias/status", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ id: m.id, status: btn.getAttribute("data-status") })
                                });
                                if (res.ok) carregarMelhorias();
                                else alert("Erro ao atualizar melhoria");
                            };
                        });
                        lista.appendChild(card);
                    });
                    // Card de melhorias rejeitadas
                    if (melhoriasRejeitadas.length) {
                        const cardRej = document.createElement("div");
                        cardRej.className = "ticket ticketRejeitadas";
                        // estilos via CSS em .ticketRejeitadas
                        cardRej.innerHTML = `<h4 style=\"color:#dc2626\">üö´ Melhorias Rejeitadas</h4>`;
                        melhoriasRejeitadas.slice().reverse().forEach(m => {
                            const item = document.createElement("div");
                            item.style.margin = "12px 0";
                            item.innerHTML = `
                                <b>${m.titulo}</b> <span style=\"font-size:13px;opacity:.8;\">${m.data}</span><br>
                                <small>Enviado por: <b>${m.autor}</b></small>
                                <button class=\"btnGhost\" data-expand>üîé Ler mais</button>
                                <div class=\"descricaoCompleta\" style=\"display:none;margin-top:8px;\">${m.descricao.replace(/\n/g,"<br>")}</div>
                            `;
                            item.querySelector("[data-expand]").onclick = function() {
                                const desc = item.querySelector(".descricaoCompleta");
                                desc.style.display = desc.style.display === "none" ? "block" : "none";
                                this.textContent = desc.style.display === "none" ? "üîé Ler mais" : "üîΩ Ocultar";
                            };
                            cardRej.appendChild(item);
                        });
                        lista.appendChild(cardRej);
                    }
                } catch (err) {
                    lista.innerHTML = "<p>Erro ao conectar.</p>";
                }
            }

            // Chama melhorias ao carregar
            carregarMelhorias();
            const tbody = document.getElementById("usersTableBody");
            const formNovo = document.getElementById("formNovoUsuario");
            const selectTeam = document.getElementById("novoTeam");

            // ‚ö° Lista de equipes
            const EQUIPES = [
                "AD TECH NEGOCIOS LTDA", "Administradores", "Agente", "Agrotitan - Equipe Consultores",
                "Agrotitan - Equipe T√©cnica", "Agrotitan - L√≠deres", "Agrotitan - Suporte", "Agrotitan - Suporte Franquias",
                "Agrotitan Fazendas - Equipe T√©cnica", "Agrotitan Fazendas - Suporte", "Analytics - B.I", "Analytics - B.I - Suporte",
                "Assessoria Produto", "Aut. Comercial - L√≠deres", "Aut. Comercial - Suporte", "Aut. Comercial - Suporte Consultores",
                "Borges e Mazete - Suporte", "Cands - Suporte", "Clientes", "Comercial", "Conselho Diretor", "Construshow - Equipe T√©cnica",
                "Construshow - L√≠deres", "Construshow - Suporte", "Construshow - Suporte Franquias", "CRM - Equipe T√©cnica", "CRM - Suporte",
                "CRM - VX", "Financeiro - VIASOFT", "GCC - Gest√£o de Combate ao Churn", "GO UP -  Suporte", "Ifact", "Link - Suporte",
                "LZ - Suporte", "Melhorias Personalizadas - ENN", "Melhorias Personalizadas - Equipe de Analistas",
                "Melhorias Personalizadas - Equipe de Desenvolvimento", "Melhorias Personalizadas - Executivos de relacionamento",
                "Melhorias Personalizadas - L√≠deres", "MN Agrobusiness", "MP AGROTECH - Suporte", "Nimitz - Lideres", "Nimitz - Suporte",
                "Nimitz - VX", "Ouvidoria", "Petroshow - Equipe T√©cnica", "Petroshow - L√≠deres", "Petroshow - Suporte", "PRODACON - Consultores",
                "PRODACON - Suporte", "Servi√ßos Fiscais - Equipe T√©cnica", "Servi√ßos Fiscais - Suporte", "Servi√ßos Fiscais - Suporte Franquias",
                "TalentRH - Equipe T√©cnica", "TalentRH - L√≠deres", "TalentRH - Suporte", "TalentRH - Suporte Franquias", "VIASOFT - Canais",
                "VIASOFT - Comit√™ de IA", "VIASOFT - Controladoria", "VIASOFT - Facilities", "VIASOFT - FinOps", "VIASOFT - HOK", "VIASOFT - HOK LMS",
                "VIASOFT - Melhorias Personalizadas", "VIASOFT - Migra√ß√µes", "VIASOFT - Sistemas Internos", "VIASOFT - Suporte a Personaliza√ß√µes",
                "VIASOFT - Suporte Oracle Cloud", "VIASOFT - Support Leaders", "VIASOFT - Tecnologia", "Viasuper - Equipe T√©cnica", "Viasuper - L√≠deres",
                "Viasuper - Suporte", "VOORS  - Suporte", "VOORS - Equipe T√©cnica", "VOORS - VX", "VX - AGROTITAN", "VX - AGROTITAN FAZENDAS",
                "VX - CONSTRUSHOW", "VX - PETROSHOW","VIABOT","VIABOT - ADM",
            ];

            // Popular select de cadastro
            EQUIPES.forEach(eq => {
                const opt = document.createElement("option");
                opt.value = eq;
                opt.textContent = eq;
                selectTeam.appendChild(opt);
            });

            // Cadastro de novo usu√°rio
            formNovo.addEventListener("submit", async (e) => {
                e.preventDefault();
                const username = document.getElementById("novoUser").value;
                const password = document.getElementById("novoPass").value;
                const team = document.getElementById("novoTeam").value;
                const role = document.getElementById("novoRole").value;
                const mustChangePassword = document.getElementById("novoMustChange").checked;

                const res = await fetch("/admin/users/create", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password, team, role, mustChangePassword })
                });

                if (res.ok) {
                    alert("‚úÖ Usu√°rio criado!");
                    formNovo.reset();
                    carregarUsuarios();
                } else {
                    alert("‚ùå Erro ao criar usu√°rio");
                }
            });

            // Carregar usu√°rios
            async function carregarUsuarios() {
                tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
                try {
                    const resp = await fetch("/admin/users");
                    if (!resp.ok) { tbody.innerHTML = "<tr><td colspan='5'>Erro ao carregar</td></tr>"; return; }
                    const users = await resp.json();

                    tbody.innerHTML = "";
                    users.forEach(u => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td><select data-team>${EQUIPES.map(eq => `<option value="${eq}" ${u.team === eq ? "selected" : ""}>${eq}</option>`).join("")}</select></td>
                <td>
                  <select data-role>
                    <option value="user" ${u.role === "user" ? "selected" : ""}>Usu√°rio</option>
                    <option value="admin" ${u.role === "admin" ? "selected" : ""}>Admin</option>
                    <option value="Supervisor" ${u.role === "Supervisor" ? "selected" : ""}>Supervisor</option>
                    <option value="Curador" ${u.role === "Curador" ? "selected" : ""}>Curador</option>
                    <option value="inactive" ${u.role === "inactive" ? "selected" : ""}>Inativo</option>
                    <option value="Support Leader" ${u.role === "Support Leader" ? "selected" : ""}>Lider Suporte</option>
                    <option value="TV" ${u.role === "TV" ? "selected" : ""}>TV</option>
                    <option value="Gerente" ${u.role === "Gerente" ? "selected" : ""}>Gerente</option>
                  </select>
                </td>
                <td>
                  <input type="checkbox" data-must-change ${u.must_change_password ? "checked" : ""} />
                </td>
                <td>
                  <button class="btnSalvar">üíæ Salvar</button>
                  <button class="btnInativar">üö´ Inativar</button>
                  <button class="btnExcluir danger">üóë Excluir</button>
                </td>
              `;

                        // eventos
                        tr.querySelector(".btnSalvar").addEventListener("click", async () => {
                            const team = tr.querySelector("[data-team]").value;
                            const role = tr.querySelector("[data-role]").value;
                            const mustChangePassword = tr.querySelector("[data-must-change]").checked;
                            const res = await fetch("/admin/users/update", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ userId: u.id, team, role, mustChangePassword })
                            });
                            alert(res.ok ? "‚úÖ Atualizado!" : "‚ùå Erro ao atualizar");
                        });

                        tr.querySelector(".btnInativar").addEventListener("click", async () => {
                            const res = await fetch("/admin/users/update", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ userId: u.id, role: "inactive", team: u.team })
                            });
                            alert(res.ok ? "üö´ Usu√°rio inativado!" : "‚ùå Erro ao inativar");
                            carregarUsuarios();
                        });

                        tr.querySelector(".btnExcluir").addEventListener("click", async () => {
                            if (!confirm("Tem certeza que deseja excluir o usu√°rio?")) return;
                            const res = await fetch("/admin/users/delete", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ userId: u.id })
                            });
                            alert(res.ok ? "üóë Usu√°rio exclu√≠do!" : "‚ùå Erro ao excluir");
                            carregarUsuarios();
                        });

                        tbody.appendChild(tr);
                    });
                } catch (err) {
                    tbody.innerHTML = "<tr><td colspan='5'>Erro ao conectar.</td></tr>";
                }
            }

            // Tema claro/escuro
            document.getElementById("toggleTheme").addEventListener("click", () => {
                document.body.classList.toggle("dark");
                document.getElementById("toggleTheme").textContent =
                    document.body.classList.contains("dark") ? "‚òÄÔ∏è Tema Claro" : "üåô Tema Escuro";
            });

            // Adiciona bot√£o Relat√≥rios ao lado do Admin se admin
            fetch("/api/me")
                .then(r => r.json())
                .then(user => {
                    if (user.role === "admin") {
                        if (!document.getElementById("relatoriosBtn")) {
                            const container = document.querySelector(".acoes");
                            const adminBtn = document.getElementById("adminBtn");
                            const link = document.createElement("a");
                            link.href = "/relatorios.html";
                            link.id = "relatoriosBtn";
                            link.className = "btnGhost sm";
                            link.textContent = "üìä Relat√≥rios";
                            container.insertBefore(link, adminBtn.nextSibling);
                        }
                    }
                })
                .catch(err => console.error("Erro ao verificar role:", err));

            carregarUsuarios();
        })();
    </script>
    <script>
    (function(){
        const normalize = (s) => (s||"")
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .toLowerCase();
        document.querySelectorAll('.adminSection > h2').forEach(h2 => {
            const t = normalize(h2.textContent);
            if (t.includes('cadastrar usuario') || t.includes('usuarios do sistema')) {
                const sec = h2.parentElement;
                sec.classList.add('collapsible','collapsed');
                h2.addEventListener('click', () => sec.classList.toggle('collapsed'));
            }
        });
    })();
    </script>
    <script>
    // Ajusta r√≥tulos/√≠cones do header do Admin sem depender de encoding do arquivo
    (function(){
        const themeBtn = document.getElementById('toggleTheme');
        if (themeBtn) { themeBtn.title = 'Tema'; if (!/\S/.test(themeBtn.textContent)) themeBtn.textContent = 'üåô Tema Escuro'; }
        const voltar = document.querySelector('a.btnGhost.sm[href="/dashboard"]');
        if (voltar) { voltar.title = 'Voltar'; voltar.textContent = 'üîô Voltar'; }
        const sair = document.getElementById('logoutBtn');
        if (sair) { sair.title = 'Sair'; sair.textContent = 'üö™ Sair'; }
    })();
    </script>
</body>
</html>
