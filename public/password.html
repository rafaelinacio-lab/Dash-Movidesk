<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trocar Senha</title>
  <link href="/style.css" rel="stylesheet" />
  <style>
    .pwBox { max-width: 420px; margin: 60px auto; padding: 24px; background: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    body.dark .pwBox { background: #111827; color: #e5e7eb; }
    .pwBox h1 { margin: 0 0 12px; font-size: 22px; }
    .pwBox p { margin: 0 0 16px; color: #6b7280; }
    body.dark .pwBox p { color: #9ca3af; }
    .pwBox label { display:block; font-weight:600; margin: 10px 0 6px; }
    .pwBox input { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; outline:none; }
    body.dark .pwBox input { background:#111827; border-color:#374151; color:#e5e7eb; }
    .pwBox .actions { margin-top:18px; display:flex; gap:10px; }
    .btn { padding:10px 14px; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; font-weight:600; }
    .btn.ghost { background:transparent; color:#374151; border:1px solid #d1d5db; }
  </style>
  <script>
    async function init() {
      try {
        const me = await fetch('/api/me').then(r=>r.json());
        const must = !!me.must_change_password;
        document.getElementById('currentPwWrap').style.display = must ? 'none' : 'block';
        document.getElementById('title').textContent = must ? 'Defina uma nova senha' : 'Trocar senha';
        document.getElementById('desc').textContent = must ? 'Você precisa alterar sua senha antes de continuar.' : 'Atualize sua senha.';
      } catch {}
    }
    async function changePw(ev){
      ev.preventDefault();
      const currentPassword = (document.getElementById('currentPassword').value||'').trim();
      const newPassword = (document.getElementById('newPassword').value||'').trim();
      const confirmPassword = (document.getElementById('confirmPassword').value||'').trim();
      const msg = document.getElementById('msg');
      msg.textContent = '';
      if (!newPassword || newPassword.length < 6) { msg.textContent = 'Nova senha deve ter ao menos 6 caracteres'; return; }
      if (newPassword !== confirmPassword) { msg.textContent = 'As senhas não conferem'; return; }
      const res = await fetch('/api/change-password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ currentPassword, newPassword }) });
      const data = await res.json().catch(()=>({}));
      if (!res.ok) { msg.textContent = data.error || 'Erro ao trocar senha'; return; }
      window.location.href = '/dashboard';
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="pwBox">
    <h1 id="title">Trocar senha</h1>
    <p id="desc">Atualize sua senha.</p>
    <form onsubmit="changePw(event)">
      <div id="currentPwWrap">
        <label for="currentPassword">Senha atual</label>
        <input id="currentPassword" type="password" autocomplete="current-password" />
      </div>
      <label for="newPassword">Nova senha</label>
      <input id="newPassword" type="password" autocomplete="new-password" required />
      <label for="confirmPassword">Confirmar senha</label>
      <input id="confirmPassword" type="password" autocomplete="new-password" required />
      <div id="msg" style="color:#b91c1c;margin-top:8px;"></div>
      <div class="actions">
        <button class="btn" type="submit">Salvar</button>
        <a href="/logout" class="btn ghost">Sair</a>
      </div>
    </form>
  </div>
</body>
</html>

