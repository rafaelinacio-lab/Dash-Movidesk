<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trocar Senha</title>
  <link href="/style.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b1220; --panel: rgba(17,24,39,.55); --panel-border: rgba(148,163,184,.25);
      --text:#e5e7eb; --muted:#94a3b8; --input-bg: rgba(2,6,23,.85); --input-border: rgba(148,163,184,.25);
      --focus:#60a5fa; --btn:#2563eb; --btn-hover:#1d4ed8; --shadow: 0 20px 40px rgba(0,0,0,.35);
    }
    body{ background:var(--bg); }
    .wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .pwBox{ position:relative; width:100%; max-width:540px; background:var(--panel); backdrop-filter: blur(10px); border:1px solid var(--panel-border); border-radius:22px; padding:28px; color:var(--text); box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,.06); }
    .pwBox::before{ content:""; position:absolute; inset:8px; border-radius:16px; border:1px solid var(--panel-border); pointer-events:none; }
    .pwBox h1{ margin:0 0 6px; font-size:22px; }
    .pwBox p{ margin:0 0 16px; color:var(--muted); }
    .fields{ display:flex; flex-direction:column; gap:14px; margin-top:6px; }
    .fields label{ display:block; font-weight:700; margin: 2px 0 6px; color:var(--text); }
    .bubble{ width:100%; padding:13px 16px; border-radius:16px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); outline:none; transition: box-shadow .2s, border-color .2s, background .2s; }
    .bubble:focus{ border-color:var(--focus); box-shadow:0 0 0 4px color-mix(in oklab, var(--focus) 25%, transparent); }
    .actions{ margin-top:18px; display:flex; gap:12px; }
    .btn{ padding:12px 18px; border:none; border-radius:14px; background:linear-gradient(180deg, var(--btn), #88a1ef); color:#fff; cursor:pointer; font-weight:800; box-shadow:0 10px 26px color-mix(in oklab, var(--btn) 35%, transparent); }
    .btn:hover{ filter:brightness(1.05); }
    .btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--panel-border); box-shadow:none; }
    #msg{ color:#b91c1c; margin-top:8px; }
  </style>
  <script>
    async function init() {
      try {
        const me = await fetch('/api/me').then(r=>r.json());
        const must = !!me.must_change_password;
        document.getElementById('currentPwWrap').style.display = must ? 'none' : 'block';
        document.getElementById('title').textContent = must ? 'Defina uma nova senha' : 'Trocar senha';
        document.getElementById('desc').textContent = must ? 'Voc√™ precisa alterar sua senha antes de continuar.' : 'Atualize sua senha.';
      } catch {}\ndocument.querySelectorAll('.eyeBtn').forEach(btn=>{ const id = btn.getAttribute('data-eye'); const input = document.getElementById(id); if(!input) return; btn.addEventListener('click', ()=>{ const vis = input.getAttribute('type')==='text'; input.setAttribute('type', vis? 'password':'text'); btn.textContent = vis? '??':'??'; }); });\n    }\n    async function changePw(ev){
      document.querySelectorAll('.eyeBtn').forEach(btn=>{ const id = btn.getAttribute('data-eye'); const input = document.getElementById(id); if(!input) return; btn.addEventListener('click', ()=>{ const vis = input.getAttribute('type')==='text'; input.setAttribute('type', vis? 'password':'text'); btn.textContent = vis? '??':'??'; }); });\n    }\n    async function changePw(ev){
      ev.preventDefault();
      const currentPassword = (document.getElementById('currentPassword').value||'').trim();
      const newPassword = (document.getElementById('newPassword').value||'').trim();
      const confirmPassword = (document.getElementById('confirmPassword').value||'').trim();
      const msg = document.getElementById('msg');
      msg.textContent = '';
      if (!newPassword || newPassword.length < 6) { msg.textContent = 'Nova senha deve ter ao menos 6 caracteres'; return; }
      if (newPassword !== confirmPassword) { msg.textContent = 'As senhas n√£o conferem'; return; }
      const res = await fetch('/api/change-password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ currentPassword, newPassword }) });
      const data = await res.json().catch(()=>({}));
      if (!res.ok) { msg.textContent = data.error || 'Erro ao trocar senha'; return; }
      window.location.href = '/dashboard';
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="wrap">
    <div class="pwBox">
      <h1 id="title">Trocar senha</h1>
      <p id="desc">Atualize sua senha.</p>
      <form onsubmit="changePw(event)">
        <div class="fields">
          <div id="currentPwWrap">
            <label for="currentPassword">Senha atual</label>
            <div class="bubble" style="padding:0;display:flex;align-items:center;">
              <input id="currentPassword" type="password" autocomplete="current-password" style="all:unset;flex:1;padding:14px 12px;color:inherit;" />
              <button type="button" class="eyeBtn" data-eye="currentPassword" aria-label="Mostrar senha" style="all:unset;cursor:pointer;padding:8px 12px;color:#a8b3c7;">üëÅ</button>
            </div>
          </div>
          <div>
            <label for="newPassword">Nova senha</label>
            <div class="bubble" style="padding:0;display:flex;align-items:center;">
              <input id="newPassword" type="password" autocomplete="new-password" required style="all:unset;flex:1;padding:14px 12px;color:inherit;" />
              <button type="button" class="eyeBtn" data-eye="newPassword" aria-label="Mostrar senha" style="all:unset;cursor:pointer;padding:8px 12px;color:#a8b3c7;">üëÅ</button>
            </div>
          </div>
          <div>
            <label for="confirmPassword">Confirmar senha</label>
            <div class="bubble" style="padding:0;display:flex;align-items:center;">
              <input id="confirmPassword" type="password" autocomplete="new-password" required style="all:unset;flex:1;padding:14px 12px;color:inherit;" />
              <button type="button" class="eyeBtn" data-eye="confirmPassword" aria-label="Mostrar senha" style="all:unset;cursor:pointer;padding:8px 12px;color:#a8b3c7;">üëÅ</button>
            </div>
          </div>
        </div>
        <div id="msg"></div>
        <div class="actions">
          <button class="btn" type="submit">Salvar</button>
          <a href="/logout" class="btn ghost">Sair</a>
        </div>
      </form>
    </div>
  </div>
</body>
</html>

