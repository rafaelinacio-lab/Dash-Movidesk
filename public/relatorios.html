<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Relat√≥rios - Dash Movidesk</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="style.css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      #teamSelect { max-width: 520px; }
      @media print {
        header, .adminForm, .appFooter, .acoes, hr { display:none !important; }
        #printArea { display:block !important; }
      }
      #printArea { display:none; }
      .error { color: #ef4444; font-weight: bold; }
    </style>
    <script>
      function toggleTheme(){ document.body.classList.toggle('dark'); }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="brandTitle">
                <img src="/logo-viasoft.png" alt="Viasoft" class="headerLogo" />
                Relat√≥rios <span>Movidesk</span>
            </h1>
            <div class="acoes">
                <button onclick="toggleTheme()" class="btnGhost sm" title="Tema">üåô Tema</button>
                <a href="/dashboard" class="btnGhost sm" title="Voltar">üîô Voltar</a>
                <a href="/logout" id="logoutBtn" class="btnGhost sm danger" title="Sair">üö™ Sair</a>
            </div>
        </header>

        <!-- üîç Pesquisa de Tickets por Servi√ßo -->
        <section class="adminSection">
            <h2>üîç Pesquisa de Tickets por Servi√ßo</h2>
            <div class="adminForm" style="margin:8px 0 12px; align-items: flex-end; gap:12px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:6px;">Termo de Servi√ßo</label>
                    <input list="serviceOptions" id="serviceSearchInput" style="min-width:300px" placeholder="Selecione um servi√ßo">
                    <datalist id="serviceOptions">
                        <option value="Agroneg√≥cio">
                        <option value="Construshow">
                        <option value="Agroneg√≥cio ¬ª Fiscal - Agrotitan">
                        <option value="Agroneg√≥cio ¬ª Orion - Agrotitan">
                        <option value="Agroneg√≥cio ¬ª Oracle Cloud">
                        <option value="Agrotitan Fazendas">
                        <option value="Analytics - B.I">
                        <option value="CRM ¬ª Varejo">
                        <option value="Supermercados">
                        <option value="Supermercados ¬ª Fiscal - Supermercados">
                        <option value="Voors">
                    </datalist>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:6px;">Per√≠odo</label>
                    <label>De: <input type="date" id="serviceDateStart"></label><br>
                    <label>At√©: <input type="date" id="serviceDateEnd"></label>
                </div>
                <div>
                    <button id="btnSearchService" class="btnSalvar">Pesquisar</button>
                </div>
            </div>
            <div id="serviceSearchResults"></div>
        </section>

        <!-- ‚öôÔ∏è Administra√ß√£o de CustomFields (somente admin) -->
        <hr style="margin:24px 0;">
        <section id="customFieldsAdmin" class="adminSection" style="display:none;">
            <h2>‚öôÔ∏è Custom Fields por Servi√ßo</h2>
            <div class="adminForm">
                <input type="text" id="cfService" placeholder="Servi√ßo (ex: Agroneg√≥cio)" />
                <input type="number" id="cfId" placeholder="Campo" />
                <input type="number" id="cfRuleId" placeholder="Regra de Exibi√ß√£o" />
                <button id="btnAddCF" class="btnSalvar">Salvar</button>
            </div>
            <table class="adminTable" id="cfTable">
                <thead>
                    <tr>
                        <th>Servi√ßo</th>
                        <th>customFieldId</th>
                        <th>customFieldRuleId</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <div class="appFooter">Desenvolvido para Viasoft ¬© 2025</div>

    <!-- ===== Script para Pesquisa de Tickets por Servi√ßo ===== -->
<script>
(function(){
  const btn = document.getElementById("btnSearchService");
  const input = document.getElementById("serviceSearchInput");
  const out = document.getElementById("serviceSearchResults");
  const dateStart = document.getElementById("serviceDateStart");
  const dateEnd = document.getElementById("serviceDateEnd");

  btn.addEventListener("click", async ()=>{
    const service = input.value.trim();
    if (!service) { alert("Informe o servi√ßo."); return; }
    out.innerHTML = "<p>Pesquisando...</p>";

    const qs = new URLSearchParams({ service });
    if (dateStart.value) qs.set("start", dateStart.value);
    if (dateEnd.value) qs.set("end", dateEnd.value);

    try {
      const r = await fetch(`/api/service-tickets?${qs.toString()}`, {
        credentials: "include"
      });
      if (!r.ok) throw new Error("HTTP "+r.status);
      const data = await r.json();

      out.innerHTML = `
        <div class="graficoCard">
          <h3>Tickets ‚Äî ${data.service}</h3>
          <canvas id="serviceChart"></canvas>
        </div>
        <p>Total: ${data.counts.total}</p>
        <div id="serviceTicketsTable"></div>
      `;

      const ctx = document.getElementById("serviceChart").getContext("2d");
      new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Novos", "Em Atendimento", "Parados", "Fechados"],
          datasets: [{
            data: [
              data.counts.new,
              data.counts.inAttendance,
              data.counts.stopped,
              data.counts.closed
            ],
            backgroundColor: ["#2563eb","#f59e0b","#dc2626","#6b7280"]
          }]
        },
        options: { responsive: true }
      });

      if (data.tickets && data.tickets.length) {
        const rows = data.tickets.map(t => `
          <tr>
            <td>${t.id}</td>
            <td>${t.subject}</td>
            <td>${t.status}</td>
            <td>${t.ownerTeam}</td>
            <td>${new Date(t.createdDate).toLocaleString("pt-BR")}</td>
            <td>${(t.serviceFull || []).join(", ")}</td>
            <td>${t.customFieldValue || "-"}</td>
            <td><button class="btnGhost sm" onclick="verTicket(${t.id})">üîç Ver</button></td>
          </tr>
        `).join("");

        document.getElementById("serviceTicketsTable").innerHTML = `
          <h4>Tickets encontrados</h4>
          <table class="adminTable">
            <thead>
              <tr>
                <th>ID</th><th>Assunto</th><th>Status</th><th>Equipe</th>
                <th>Data Cria√ß√£o</th><th>Servi√ßo</th><th>Campo Adicional</th><th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    } catch(e){
      out.innerHTML = `<p class="error">Erro: ${e.message}</p>`;
    }
  });

  input.addEventListener("keyup", (e)=>{ if (e.key === "Enter") btn.click(); });

  window.verTicket = async function(ticketId){
    try {
      const r = await fetch(`/api/ticket/${ticketId}`, { credentials: "include" });
      if (!r.ok) throw new Error("HTTP "+r.status);
      const t = await r.json();
      alert(
        `üîé Ticket #${t.id}\n\n` +
        `Assunto: ${t.subject}\n` +
        `Status: ${t.status}\n` +
        `Equipe: ${t.ownerTeam}\n` +
        `Solicitante: ${t.requester}\n` +
        `Criado em: ${new Date(t.createdDate).toLocaleString("pt-BR")}`
      );
    } catch(e){
      alert("Erro ao buscar detalhes: " + e.message);
    }
  }
})();

// ===== Script Administra√ß√£o de CustomFields =====
(async function(){
  try {
    const me = await fetch("/api/me", {credentials:"include"}).then(r=>r.json());
    if(me.role === "admin") {
      document.getElementById("customFieldsAdmin").style.display = "";
      loadCFs();
    }
  } catch {}

  async function loadCFs(){
    const tb = document.querySelector("#cfTable tbody");
    tb.innerHTML = "<tr><td colspan=4>Carregando...</td></tr>";
    const r = await fetch("/api/custom-fields", {credentials:"include"});
    if(!r.ok) return;
    const data = await r.json();
    tb.innerHTML = data.map(cf=>`
      <tr>
        <td>${cf.service}</td>
        <td>${cf.customFieldId}</td>
        <td>${cf.customFieldRuleId}</td>
        <td><button class="btnExcluir" onclick="deleteCF(${cf.id})">Excluir</button></td>
      </tr>
    `).join("");
  }

  document.getElementById("btnAddCF").onclick = async ()=>{
    const service = document.getElementById("cfService").value.trim();
    const cfId = document.getElementById("cfId").value;
    const cfRuleId = document.getElementById("cfRuleId").value;
    if(!service||!cfId||!cfRuleId){ alert("Preencha todos os campos."); return; }
    await fetch("/api/custom-fields", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ service, customFieldId:cfId, customFieldRuleId:cfRuleId })
    });
    loadCFs();
  }

  window.deleteCF = async (id)=>{
    if(!confirm("Excluir este registro?")) return;
    await fetch("/api/custom-fields/"+id,{method:"DELETE",credentials:"include"});
    loadCFs();
  }
})();
</script>
</body>
</html>
