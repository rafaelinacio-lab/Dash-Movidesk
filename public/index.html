<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard de Tickets</title>
    <link href="style.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <header>
        <h1 class="brandTitle">
            <img src="/logo-viasoft.png" alt="Viasoft" class="headerLogo" />
            Tickets <span> Movidesk</span>
        </h1>
        <div class="acoes">
            <div class="notif">
                <button id="notifBtn" class="btnGhost sm" aria-label="Notifica√ß√µes">
                    üîî
                    <span id="notifCount" class="notifCount" hidden>0</span>
                </button>
                <div id="notifPanel" class="notifPanel" aria-hidden="true">
                    <div class="notifHead">
                        <strong>Notifica√ß√µes</strong>
                        <button id="notifClear" class="btnGhost sm">Limpar</button>
                    </div>
                    <ul id="notifList" class="notifList"></ul>
                </div>
            </div>

            <div class="searchWrap" id="ticketSearchWrap">
                <input type="search" id="ticketSearch" placeholder="Buscar ticket (ID)" />
                <button id="ticketSearchBtn" class="btnGhost">Buscar</button>
            </div>

            <button id="toggleTheme" class="btnGhost sm">üåô Tema Escuro</button>
            <button id="btnMelhoria" class="btnGhost sm" title="Sugerir melhoria">üí° Sugerir Melhoria</button>
            <a href="/logout" id="logoutBtn" class="btnGhost sm danger">üö™ Sair</a>
        </div>
    </header>

    <div class="cards">
        <div class="cardWidget azul">
            <div class="cardInfo"><h3>Tickets Criados (M√™s)</h3><p id="totalTickets">0</p></div>
            <div class="iconBox"><span>üë•</span></div>
        </div>
        <div class="cardWidget laranja">
            <div class="cardInfo"><h3>Novos</h3><p id="novos">0</p></div>
            <div class="iconBox"><span>‚ûï</span></div>
        </div>
        <div class="cardWidget verde">
            <div class="cardInfo"><h3>Em Atendimento</h3><p id="emAtendimento">0</p></div>
            <div class="iconBox"><span>üìà</span></div>
        </div>
        <div class="cardWidget cinza">
            <div class="cardInfo"><h3>Aguardando</h3><p id="parados">0</p></div>
            <div class="iconBox"><span>‚è∏Ô∏è</span></div>
        </div>
        <div class="cardWidget roxo">
            <div class="cardInfo"><h3>Em Aberto</h3><p id="abertos">0</p></div>
            <div class="iconBox"><span>üìÇ</span></div>
        </div>
        <div class="cardWidget vermelho">
            <div class="cardInfo"><h3>Cr√≠ticos</h3><p id="criticos">0</p></div>
            <div class="iconBox"><span>üõë</span></div>
        </div>
    </div>

    <div class="kanban">
        <div class="coluna amarelo">
            <h3>Novo (<span id="countNovos">0</span>)</h3>
            <div class="lista" id="novosLista"></div>
            <button class="btnMore" data-col="novos">Ver mais</button>
        </div>
        <div class="coluna azulClaro">
            <h3>Em Atendimento (<span id="countAtendimento">0</span>)</h3>
            <div class="lista" id="atendimentoLista"></div>
            <button class="btnMore" data-col="atendimento">Ver mais</button>
        </div>
        <div class="coluna vermelhoClaro">
            <h3>Aguardando (<span id="countParados">0</span>)</h3>
            <div class="lista" id="paradosLista"></div>
            <button class="btnMore" data-col="parados">Ver mais</button>
        </div>
        <div class="coluna vencidoClaro">
            <h3>Vencidos (<span id="countVencidos">0</span>)</h3>
            <div class="lista" id="vencidosLista"></div>
            <button class="btnMore" data-col="vencidos">Ver mais</button>
        </div>
        <div class="graficoStack">
            <div class="graficoCard" id="cardPrioridade">
                <h3>Distribui√ß√£o por Prioridade</h3>
                <canvas id="graficoDonut"></canvas>
                <div id="graficoMsg" class="graficoMsg"></div>
                <ul id="graficoLegenda" class="legendList"></ul>
            </div>
            <div class="graficoCard" id="cardAgentes">
                <h3>Distribui√ß√£o por Agente (ativos)</h3>
                <canvas id="graficoDonutAgents"></canvas>
                <div id="graficoMsgAgents" class="graficoMsg"></div>
                <ul id="graficoLegendaAgents" class="legendList"></ul>
            </div>
        </div>
    </div>
</div>

<div id="inativacaoOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modalBox" role="dialog" aria-modal="true" aria-labelledby="inativacaoTitle">
        <h3 id="inativacaoTitle">‚ö†Ô∏è Novos Tickets Urgentes</h3>
        <ul id="inativacaoList"></ul>
        <div class="modalActions">
            <button id="inativacaoClose" class="btnGhost">Fechar</button>
        </div>
    </div>
</div>

<div id="ticketOverlay" class="modalOverlay" aria-hidden="true"></div>

<div id="modalMelhoria" class="modalOverlay" aria-hidden="true">
    <div class="modalBox" role="dialog" aria-modal="true">
        <h3>üí° Sugerir Melhoria</h3>
        <form id="formMelhoria" style="display:flex;flex-direction:column;gap:10px;">
            <input type="text" id="melhoriaTitulo" placeholder="T√≠tulo da melhoria" required />
            <textarea id="melhoriaDescricao" placeholder="Descreva a sugest√£o" required rows="4"></textarea>
            <input type="text" id="melhoriaAutor" placeholder="Seu nome ou usu√°rio" required readonly />
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="submit" class="btnSalvar">Enviar</button>
                <button type="button" id="fecharMelhoria" class="btnGray">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalMinhasMelhorias" class="modalOverlay" aria-hidden="true">
    <div class="modalBox" role="dialog" aria-modal="true">
        <h3>üìã Minhas Melhorias</h3>
        <div id="minhasMelhoriasConteudo">Carregando...</div>
        <div class="modalActions" style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
            <button id="fecharMinhasMelhorias" class="btnGray">Fechar</button>
        </div>
    </div>
</div>

<div class="appFooter">Desenvolvido para Viasoft ¬© 2025</div>

<script>
(() => {
    /* ===== Melhoria ===== */
    const btnMelhoria = document.getElementById("btnMelhoria");
    const modalMelhoria = document.getElementById("modalMelhoria");
    const formMelhoria = document.getElementById("formMelhoria");
    const fecharMelhoria = document.getElementById("fecharMelhoria");
    const melhoriaAutor = document.getElementById("melhoriaAutor");

    async function getUsuarioLogado() {
        try {
            const res = await fetch("/api/me");
            if (!res.ok) return "Usu√°rio";
            const user = await res.json();
            return user.username || "Usu√°rio";
        } catch { return "Usu√°rio"; }
    }

    btnMelhoria.onclick = () => {
        getUsuarioLogado().then(nome => { melhoriaAutor.value = nome; });
        modalMelhoria.classList.add("show");
        modalMelhoria.setAttribute("aria-hidden","false");
    };
    fecharMelhoria.onclick = () => {
        modalMelhoria.classList.remove("show");
        modalMelhoria.setAttribute("aria-hidden","true");
    };
    formMelhoria.onsubmit = async (e) => {
        e.preventDefault();
        const titulo = document.getElementById("melhoriaTitulo").value;
        const descricao = document.getElementById("melhoriaDescricao").value;
        const autor = melhoriaAutor.value;
        const res = await fetch("/api/melhorias/sugerir", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ titulo, descricao, autor })
        });
        if (res.ok) { alert("‚úÖ Melhoria enviada!"); formMelhoria.reset(); fecharMelhoria.click(); }
        else { alert("‚ùå Erro ao enviar melhoria"); }
    };

    // Bot√£o "Minhas melhorias"
    (function(){
        const actions = document.querySelector('.acoes');
        if (actions && !document.getElementById('btnMinhasMelhorias')) {
            const btn = document.createElement('button');
            btn.id = 'btnMinhasMelhorias';
            btn.className = 'btnGhost sm';
            btn.title = 'Minhas melhorias';
            btn.textContent = 'üìã Minhas Melhorias';
            const logout = document.getElementById('logoutBtn');
            if (logout) actions.insertBefore(btn, logout); else actions.appendChild(btn);
        }
    })();
    const btnMinhas = document.getElementById('btnMinhasMelhorias');
    const modalMinhas = document.getElementById('modalMinhasMelhorias');
    const fecharMinhas = document.getElementById('fecharMinhasMelhorias');
    const minhasConteudo = document.getElementById('minhasMelhoriasConteudo');
    async function getMe(){ try{ const r=await fetch('/api/me'); if(!r.ok) return null; return await r.json(); } catch { return null; } }
    function openMinhas(){ modalMinhas.classList.add('show'); modalMinhas.setAttribute('aria-hidden','false'); }
    function closeMinhas(){ modalMinhas.classList.remove('show'); modalMinhas.setAttribute('aria-hidden','true'); }
    if (btnMinhas) {
        btnMinhas.addEventListener('click', async ()=>{
            openMinhas();
            minhasConteudo.textContent = 'Carregando...';
            const me = await getMe(); if(!me){ minhasConteudo.textContent='N√£o autenticado.'; return; }
            try{
                const r = await fetch('/api/melhorias'); if(!r.ok){ minhasConteudo.textContent='Erro ao carregar melhorias.'; return; }
                const lista = await r.json();
                const minhas = (lista||[]).filter(m => (m.autor||'').toLowerCase() === (me.username||'').toLowerCase());
                if(!minhas.length){ minhasConteudo.textContent='Voc√™ ainda n√£o enviou melhorias.'; return; }
                const wrap = document.createElement('div');
                minhas.forEach(m=>{
                    const item = document.createElement('div');
                    item.className='ticket';
                    const status = m.status || 'Enviada';
                    const color = status==='Implementada'?'#16a34a':(status.toLowerCase().includes('an')?'#f59e0b':status==='Rejeitada'?'#dc2626':'#2563eb');
                    item.innerHTML = `<h4>${m.titulo}</h4>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                            <small>Enviado em: ${new Date(m.data).toLocaleDateString()||'-'}</small>
                            <span class="badge" style="background:${color}">${status}</span>
                        </div>
                        <div class="descricaoCompleta" style="margin-top:8px;">${(m.descricao||'').replace(/\n/g,'<br>')}</div>`;
                    wrap.appendChild(item);
                });
                minhasConteudo.innerHTML=''; minhasConteudo.appendChild(wrap);
            }catch{ minhasConteudo.textContent='Erro ao conectar.'; }
        });
    }
    if (fecharMinhas) fecharMinhas.addEventListener('click', closeMinhas);

    /* ===== Cores / Helpers ===== */
    const urgencyColors = { "Cr√≠tica":"#ef4444","Alta":"#f97316","M√©dia":"#3b82f6","Baixa":"#6b7280","N√£o definida":"#9ca3af" };
    const agentPalette = ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#ec4899","#a855f7","#f97316","#22c55e","#0ea5e9","#eab308","#dc2626","#14b8a6","#64748b","#d946ef","#60a5fa"];
    const slug = (s) => (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    const matchesKeywordAlert = (text) => {
        const st = slug(text);
        return st.includes("contexto") || st.includes("inativacao") || (st.includes("inativacao") && st.includes("movidesk"));
    };
    const isCanceled = (t) => t.baseStatus==="Canceled" || t.baseStatus==="Cancelled" || String(t.status||"").toLowerCase().includes("cancelad");
    const ACTIVE_BASE = new Set(["New","InAttendance","Stopped"]);
    const isAguardFornecedor = (t) => { const s = slug(t.status || ""); return s.includes("aguard") && s.includes("fornecedor"); };

    /* ===== Donut Prioridade ===== */
    const ensureDonutHolders = () => {
        const card = document.getElementById("cardPrioridade");
        let canvas = document.getElementById("graficoDonut");
        let msg = document.getElementById("graficoMsg");
        let legenda = document.getElementById("graficoLegenda");
        if (!canvas){canvas=document.createElement("canvas");canvas.id="graficoDonut";card.querySelector("h3").after(canvas);}
        if (!msg){msg=document.createElement("div");msg.id="graficoMsg";msg.className="graficoMsg";canvas.after(msg);}
        if (!legenda){legenda=document.createElement("ul");legenda.id="graficoLegenda";legenda.className="legendList";msg.after(legenda);}
        return {canvas,msg,legenda};
    };
    const renderLegend = (prioridades) => {
        const { legenda } = ensureDonutHolders();
        legenda.innerHTML="";
        Object.keys(prioridades||{}).forEach((label)=>{
            const qty = prioridades[label] ?? 0;
            const color = urgencyColors[label] || "#9ca3af";
            const li = document.createElement("li");
            li.innerHTML = `<div class="legendLeft"><span class="legendDot" style="background:${color}"></span><span class="legendName">${label}</span></div><span class="legendQty">${qty}</span>`;
            legenda.appendChild(li);
        });
    };
    const renderDonut = (prioridades) => {
        const { canvas, msg } = ensureDonutHolders();
        if (window.graficoDonut){ try{window.graficoDonut.destroy();}catch(_){}}
        const labels = Object.keys(prioridades||{}), values = Object.values(prioridades||{});
        if (!labels.length){ if (msg) msg.textContent="Sem dados para exibir."; renderLegend({}); return; }
        else if (msg) msg.textContent="";
        window.graficoDonut = new Chart(canvas,{
            type:"doughnut",
            data:{ labels, datasets:[{ data:values, backgroundColor:labels.map(urg=>urgencyColors[urg]||"#9ca3af") }]},
            options:{ plugins:{ legend:{ display:false } }, cutout:"60%" }
        });
        renderLegend(prioridades);
    };

    /* ===== Donut Agentes ===== */
    const ensureDonutHoldersAgents = () => {
        const card = document.getElementById("cardAgentes");
        let canvas = document.getElementById("graficoDonutAgents");
        let msg = document.getElementById("graficoMsgAgents");
        let legenda = document.getElementById("graficoLegendaAgents");
        if (!canvas){canvas=document.createElement("canvas");canvas.id="graficoDonutAgents";card.querySelector("h3").after(canvas);}
        if (!msg){msg=document.createElement("div");msg.id="graficoMsgAgents";msg.className="graficoMsg";canvas.after(msg);}
        if (!legenda){legenda=document.createElement("ul");legenda.id="graficoLegendaAgents";legenda.className="legendList";msg.after(legenda);}
        return {canvas,msg,legenda};
    };
    let agentIdsMap = {};
    const renderLegendAgents = (mapa) => {
        const { legenda } = ensureDonutHoldersAgents();
        legenda.innerHTML="";
        Object.keys(mapa||{}).forEach((name,i)=>{
            const qty = mapa[name] ?? 0;
            const color = agentPalette[i % agentPalette.length];
            const ids = (agentIdsMap[name]||[]).slice().sort((a,b)=>Number(a)-Number(b));
            const badges = ids.map(id=>`<span class="legendTicketBadge">#${id}</span>`).join("");
            const li = document.createElement("li");
            li.innerHTML = `
                <div class="legendLeft"><span class="legendDot" style="background:${color}"></span><span class="legendName">${name}</span></div>
                <span class="legendQty">${qty}</span>
                <div class="legendTickets" aria-hidden="true">${badges}</div>`;
            li.addEventListener("click",()=>{
                legenda.querySelectorAll(".legendTickets.show").forEach(el=>{ if (el!==li.lastElementChild){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }});
                const drop = li.lastElementChild; const will = !drop.classList.contains("show");
                drop.classList.toggle("show", will); drop.setAttribute("aria-hidden", String(!will));
            });
            legenda.appendChild(li);
        });
    };
    const renderDonutAgents = (mapa) => {
        const { canvas, msg } = ensureDonutHoldersAgents();
        if (window.graficoDonutAgents){ try{window.graficoDonutAgents.destroy();}catch(_){}}
        const labels = Object.keys(mapa||{}), values = Object.values(mapa||{});
        if (!labels.length){ if (msg) msg.textContent="Sem dados para exibir."; renderLegendAgents({}); return; }
        else if (msg) msg.textContent="";
        window.graficoDonutAgents = new Chart(canvas,{
            type:"doughnut",
            data:{ labels, datasets:[{ data:values, backgroundColor:labels.map((_,i)=>agentPalette[i%agentPalette.length]) }]},
            options:{ plugins:{ legend:{ display:false } }, cutout:"60%" }
        });
        renderLegendAgents(mapa);
    };

    /* ===== Pagina√ß√£o & Render ===== */
    const PAGE = 5;
    const colData = {novos:[],atendimento:[],parados:[],vencidos:[]};
    const visibleCount = {novos:PAGE,atendimento:PAGE,parados:PAGE,vencidos:PAGE};

    const buildTicketCard = (t) => {
        const statusSlug = slug(t.status || "nao definido");
        const urgSlug  = slug(t.urgency || "N√£o definida");
        let prevSolTxt = "-", prevClass = "gray";
        if (t.previsaoSolucao){
            const today = new Date(); const base = new Date(today.getFullYear(),today.getMonth(),today.getDate());
            const due = new Date(t.previsaoSolucao+"T23:59:59");
            const diffDays = Math.ceil((due - base)/86400000);
            prevSolTxt = due.toLocaleDateString();
            if (diffDays < 0 || t.overdue) prevClass = "red";
            else if (diffDays <= 2) prevClass = "orange";
            else prevClass = "green";
        }
        const hasAlert = matchesKeywordAlert(t.subject||"");
        const card = document.createElement("div");
        card.className = "ticket" + (hasAlert ? " alert" : "");
        card.dataset.ticketId = t.id;
        if (t.overdue && !hasAlert) card.style.outline = "2px solid rgba(220,38,38,.45)";
        card.innerHTML = `
            <h4>#${t.id} - ${t.subject}</h4>
            <p><b>Urg√™ncia:</b> <span class="pill urg-${urgSlug}">${t.urgency || "N√£o definida"}</span></p>
            <p><b>Status detalhado:</b> <span class="statusDetalhado status-${statusSlug}">${t.status || "N√£o definido"}</span></p>
            <p><b>Prev. solu√ß√£o:</b> <span class="badgePrev ${prevClass}">${prevSolTxt}</span></p>
            <div class="responsavelBox"><span class="badge responsavel">${t.owner}</span></div>
            <small>Criado em ${t.createdDate ? new Date(t.createdDate).toLocaleDateString() : "-"}</small>`;
        return card;
    };

    const renderColumns = () => {
        document.getElementById("countNovos").textContent       = colData.novos.length;
        document.getElementById("countAtendimento").textContent = colData.atendimento.length;
        document.getElementById("countParados").textContent     = colData.parados.length;
        document.getElementById("countVencidos").textContent    = colData.vencidos.length;

        const defs = [
            {key:"novos",listId:"novosLista",btnSel:'button[data-col="novos"]'},
            {key:"atendimento",listId:"atendimentoLista",btnSel:'button[data-col="atendimento"]'},
            {key:"parados",listId:"paradosLista",btnSel:'button[data-col="parados"]'},
            {key:"vencidos",listId:"vencidosLista",btnSel:'button[data-col="vencidos"]'},
        ];
        defs.forEach(({key,listId,btnSel})=>{
            const list=document.getElementById(listId);
            const btn=document.querySelector(btnSel);
            list.innerHTML="";
            const total=colData[key].length;
            const showN=Math.min(visibleCount[key], total);
            colData[key].slice(0,showN).forEach(t=>list.appendChild(buildTicketCard(t)));
            if (btn) btn.style.display = total > showN ? "block" : "none";
        });
    };

    function attachMoreHandlers(){
        document.querySelectorAll(".btnMore").forEach(btn=>{
            btn.addEventListener("click",()=>{
                const col=btn.getAttribute("data-col");
                visibleCount[col]+=PAGE;
                renderColumns();
            });
        });
    }

    // Foco em um card pelo ID
    const focusTicketById = (id) => {
        const normId = String(id);
        const colsOrder = ["novos","atendimento","parados","vencidos"];
        let found = null;
        for (const key of colsOrder){
            const idx = colData[key].findIndex(t => String(t.id) === normId);
            if (idx !== -1){ found = { key, idx }; break; }
        }
        const ensureHighlight = () => {
            const el = document.querySelector(`[data-ticket-id="${normId}"]`);
            if (el){
                el.scrollIntoView({ behavior:"smooth", block:"center", inline:"center" });
                el.classList.add("alert");
                el.style.transition = "box-shadow .2s ease";
                el.style.boxShadow  = "0 0 0 4px rgba(239,68,68,.25)";
                setTimeout(()=>{ el.style.boxShadow=""; }, 400);
            }
        };
        if (!found){ ensureHighlight(); return; }
        const { key, idx } = found;
        if (visibleCount[key] < idx + 1){ visibleCount[key] = idx + 1; renderColumns(); }
        requestAnimationFrame(ensureHighlight);
    };

    /* ===== Notifica√ß√µes ===== */
    const NOTIF_KEY = "movidesk.notifs";
    const NOTIF_LAST_CLEAR_KEY = "movidesk.notifs.lastClear";
    const ymdLocal = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    let notifStore = [];
    const notifBtn   = document.getElementById("notifBtn");
    const notifCount = document.getElementById("notifCount");
    const notifPanel = document.getElementById("notifPanel");
    const notifList  = document.getElementById("notifList");
    const notifClear = document.getElementById("notifClear");

    const loadNotifs = () => { try { notifStore = JSON.parse(localStorage.getItem(NOTIF_KEY)||"[]"); } catch { notifStore = []; } };
    const saveNotifs = () => localStorage.setItem(NOTIF_KEY, JSON.stringify(notifStore));
    const renderNotifs = () => {
        notifList.innerHTML = "";
        if (!notifStore.length){
            const li = document.createElement("li"); li.className = "notifItem"; li.innerHTML = "Nenhuma notifica√ß√£o por enquanto."; notifList.appendChild(li);
        } else {
            notifStore.slice().sort((a,b)=>b.time-a.time).forEach(n => {
                const li = document.createElement("li"); li.className = "notifItem";
                li.innerHTML = `<b>#${n.id}</b> ‚Äî ${n.subject}<br><small>${new Date(n.time).toLocaleString()}</small>`;
                li.addEventListener("click", ()=>{ notifPanel.classList.remove("show"); notifPanel.setAttribute("aria-hidden","true"); focusTicketById(n.id); });
                notifList.appendChild(li);
            });
        }
        if (notifStore.length){ notifCount.hidden = false; notifCount.textContent = String(notifStore.length); } else { notifCount.hidden = true; }
    };
    const pushNotif = ({id, subject}) => { if (!notifStore.some(n => n.id === id)){ notifStore.push({ id, subject, time: Date.now() }); saveNotifs(); renderNotifs(); } };
    const clearNotifs = () => { notifStore = []; saveNotifs(); renderNotifs(); localStorage.setItem(NOTIF_LAST_CLEAR_KEY, ymdLocal(new Date())); };
    notifBtn.addEventListener("click", ()=>{ const showing = notifPanel.classList.toggle("show"); notifPanel.setAttribute("aria-hidden", String(!showing)); });
    notifClear.addEventListener("click", clearNotifs);
    document.addEventListener("click", (ev)=>{ if (!notifPanel.contains(ev.target) && !notifBtn.contains(ev.target)){ notifPanel.classList.remove("show"); notifPanel.setAttribute("aria-hidden","true"); } });
    loadNotifs(); renderNotifs();

    // Limpeza di√°ria √†s 18h
    (function scheduleDailyNotifClearAt18(){
        const now = new Date(); const todayISO = ymdLocal(now);
        const last = localStorage.getItem(NOTIF_LAST_CLEAR_KEY) || "";
        const today18 = new Date(); today18.setHours(18,0,0,0);
        if (now >= today18 && last !== todayISO) clearNotifs();
        const next = new Date(); next.setHours(18,0,0,0); if (now >= next) next.setDate(next.getDate() + 1);
        setTimeout(() => { clearNotifs(); setInterval(clearNotifs, 24*60*60*1000); }, next.getTime() - now.getTime());
    })();

    /* ===== Modal alerta palavras-chave ===== */
    const alertedIds = new Set(); let alertAutoTimer = null;
    const closeInativacaoModal = () => {
        const overlay = document.getElementById("inativacaoOverlay");
        overlay.classList.remove("show"); overlay.setAttribute("aria-hidden","true");
        if (alertAutoTimer){ clearTimeout(alertAutoTimer); alertAutoTimer = null; }
    };
    const openInativacaoModal = (items) => {
        if (!items.length) return;
        const overlay = document.getElementById("inativacaoOverlay");
        const list = document.getElementById("inativacaoList");
        list.innerHTML = "";
        items.forEach(({id, subject}) => {
            const li = document.createElement("li");
            li.textContent = `#${id} ‚Äî ${subject}`;
            li.addEventListener("click", () => { closeInativacaoModal(); focusTicketById(id); });
            list.appendChild(li);
        });
        overlay.classList.add("show"); overlay.setAttribute("aria-hidden","false");
        if (alertAutoTimer) clearTimeout(alertAutoTimer);
        alertAutoTimer = setTimeout(closeInativacaoModal, 60000);
    };
    document.getElementById("inativacaoClose").addEventListener("click", closeInativacaoModal);

    /* ===== Carga principal ===== */
    async function carregarDashboard(){
        let dados;
        try{
            const resp = await fetch("/api/tickets");
            if (resp.status === 401) { window.location.href = "/login"; return; }
            dados = await resp.json();
        }catch(e){
            console.error("Erro ao buscar /api/tickets:", e);
            const { msg } = ensureDonutHolders(); if (msg) msg.textContent="Erro ao buscar dados."; renderLegend({});
            const ag = ensureDonutHoldersAgents(); if (ag.msg) ag.msg.textContent="Erro ao buscar dados."; renderLegendAgents({});
            return;
        }

        document.getElementById("totalTickets").innerText = dados.counts?.MonthOpenedAll ?? 0;

        try{
            const view = localStorage.getItem('kanban.view') || 'geral';
            const owner = localStorage.getItem('kanban.owner') || '';
            if (view === 'individual' && owner){
                const norm = (s)=> (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
                const filtered = (dados.tickets||[]).filter(t => norm(t.owner||'') === norm(owner));
                const hoje = new Date(); const mesAtual = hoje.getMonth(); const anoAtual = hoje.getFullYear();
                const ticketsMes = filtered.filter(t=>{ if(!t.createdDate) return false; const d=new Date(t.createdDate); return d.getMonth()===mesAtual && d.getFullYear()===anoAtual; }).length;
                const countsPerUrgency = {}; const countsPerOwner = {};
                filtered.forEach(t=>{ const u=t.urgency||'N√£o definida'; countsPerUrgency[u]=(countsPerUrgency[u]||0)+1; countsPerOwner[t.owner]=(countsPerOwner[t.owner]||0)+1; });
                dados.tickets = filtered;
                if (!dados.counts) dados.counts = {};
                dados.counts.MonthOpenedAll = ticketsMes;
                dados.countsPerUrgency = countsPerUrgency;
                dados.countsPerOwner = countsPerOwner;
                document.getElementById("totalTickets").innerText = ticketsMes;
            }
        }catch{}

        colData.novos = []; colData.atendimento = []; colData.parados = []; colData.vencidos = [];
        visibleCount.novos = visibleCount.atendimento = visibleCount.parados = visibleCount.vencidos = PAGE;

        const ativos = (dados.tickets||[]).filter(t=>{
            if (isCanceled(t)) return false;
            if (t.baseStatus==="Closed" || t.baseStatus==="Resolved") return false;
            return ACTIVE_BASE.has(t.baseStatus) || isAguardFornecedor(t);
        });

        const toAlert = [];
        ativos.forEach(t=>{
            const isNew = t.baseStatus === "New";
            const hit   = isNew && matchesKeywordAlert(t.subject||"");
            if (hit && !alertedIds.has(t.id)) toAlert.push({id:t.id, subject:t.subject||"(sem assunto)"});
            if (isNew && hit){ colData.novos.unshift(t); return; }
            if (t.overdue) colData.vencidos.push(t);
            else if (isNew) colData.novos.push(t);
            else if (t.baseStatus==="InAttendance") colData.atendimento.push(t);
            else if (t.baseStatus==="Stopped" || isAguardFornecedor(t)) colData.parados.push(t);
        });

        document.getElementById("novos").innerText         = colData.novos.length;
        document.getElementById("emAtendimento").innerText = colData.atendimento.length;
        document.getElementById("parados").innerText       = colData.parados.length;
        document.getElementById("abertos").innerText       = colData.novos.length + colData.atendimento.length + colData.parados.length;
        document.getElementById("criticos").innerText      = ativos.filter(t=>t.urgency==="Cr√≠tica").length;

        renderColumns();

        if (toAlert.length){ toAlert.forEach(it=>{ alertedIds.add(it.id); pushNotif(it); }); openInativacaoModal(toAlert); }

        let prioridades = dados.countsPerUrgency;
        if (!prioridades || !Object.keys(prioridades).length){
            const calc={}; ativos.forEach(t=>{ const u=t.urgency||"N√£o definida"; calc[u]=(calc[u]||0)+1; }); prioridades = calc;
        }
        renderDonut(prioridades);

        agentIdsMap = {};
        ativos.forEach(t => { const name=t.owner||"N√£o atribu√≠do"; (agentIdsMap[name] ||= []).push(t.id); });
        let porAgente = dados.countsPerOwner;
        if (!porAgente || !Object.keys(porAgente).length){
            porAgente = {}; Object.keys(agentIdsMap).forEach(n => porAgente[n] = agentIdsMap[n].length);
        }
        renderDonutAgents(porAgente);

        try { if (window.__updateOwnerOptionsFromTickets) window.__updateOwnerOptionsFromTickets(ativos); } catch {}
    }

    window.carregarDashboard = carregarDashboard;

    document.getElementById("toggleTheme").addEventListener("click",()=>{
        document.body.classList.toggle("dark");
        document.getElementById("toggleTheme").textContent =
            document.body.classList.contains("dark") ? "‚òÄÔ∏è Tema Claro" : "üåô Tema Escuro";
    });

    attachMoreHandlers();
    carregarDashboard();
    setInterval(carregarDashboard, 180000); // 3 minutos
})();
</script>

<script>
const checarAdmin = async () => {
    try {
        const resp = await fetch("/api/me");
        if (!resp.ok) return;
        const user = await resp.json();
        if (user.role === "admin") {
            const container = document.querySelector(".acoes");
            let adminBtn = document.getElementById("adminBtn");
            if (!adminBtn) {
                adminBtn = document.createElement("a");
                adminBtn.href = "/admin.html";
                adminBtn.id = "adminBtn";
                adminBtn.className = "btnGhost sm";
                adminBtn.textContent = "‚öôÔ∏è Admin";
                container.insertBefore(adminBtn, document.getElementById("logoutBtn"));
            }
            if (!document.getElementById("relatoriosBtn")) {
                const relBtn = document.createElement("a");
                relBtn.href = "/relatorios.html";
                relBtn.id = "relatoriosBtn";
                relBtn.className = "btnGhost sm";
                relBtn.textContent = "üìä Relat√≥rios";
                container.insertBefore(relBtn, adminBtn.nextSibling);
            }
        }
    } catch (err) {
        console.error("Erro ao checar admin:", err);
    }
};
checarAdmin();
</script>

<script>
(function(){
    const input = document.getElementById('ticketSearch');
    const btn   = document.getElementById('ticketSearchBtn');

    function parseId(v){
        const m = String(v||'').match(/^\s*#?\s*(\d+)\s*$/);
        return m ? m[1] : null;
    }

    async function abrirPorId(id){
        if (typeof window.openTicketById === 'function') {
            window.openTicketById(id);
            return;
        }
        console.error("Fun√ß√£o 'openTicketById' n√£o definida.");
    }

    async function onBuscar(){
        const id = parseId(input.value);
        if(!id){ alert('Digite o n√∫mero do ticket (ex.: 760860).'); input.focus(); return; }
        await abrirPorId(id);
    }

    btn.addEventListener('click', onBuscar, true);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); onBuscar(); } }, true);

    // L√≥gica do Modal
    function ensureOverlay(){
        let ov = document.getElementById('ticketOverlay');
        if(!ov){
            ov = document.createElement('div'); ov.id = 'ticketOverlay'; ov.className = 'modalOverlay'; ov.setAttribute('aria-hidden','true'); document.body.appendChild(ov);
        }
        if(!ov.querySelector('.modalBox')){
            const box = document.createElement('div'); box.className = 'modalBox'; ov.appendChild(box);
        }
        return ov;
    }
    function close(){ const ov = ensureOverlay(); ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }
    function renderLoading(id){
        const ov = ensureOverlay();
        const box = ov.querySelector('.modalBox');
        box.innerHTML = `<h3>Ticket #${id}</h3><p>Carregando detalhes...</p><div class="modalActions"><button class="btnGray" id="ticketCloseBtn">Fechar</button></div>`;
        ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
        box.querySelector('#ticketCloseBtn').addEventListener('click', close);
        ov.addEventListener('click', (e)=>{ if(e.target===ov) close(); }, { once:true });
    }
    function renderTicket(t){
        const ov = ensureOverlay();
        const box = ov.querySelector('.modalBox');
        const prev = t.previsaoSolucao ? new Date(t.previsaoSolucao+'T00:00:00') : null;
        const requester = t.requester || '-';
        const descr = (t.description||'Sem descri√ß√£o.').replace(/<[^>]*>?/gm, ' ').replace(/\s+/g, ' ').trim().replace(/\n/g,'<br>');
        box.innerHTML = `
            <h3>Ticket #${t.id}</h3>
            <p><strong>Assunto:</strong> ${t.subject||'-'}</p>
            <p><strong>Solicitante:</strong> ${requester}</p>
            <p><strong>Status:</strong> ${t.status || t.baseStatus || '-'}</p>
            <p><strong>Urg√™ncia:</strong> ${t.urgency || '-'}</p>
            <p><strong>Criado em:</strong> ${t.createdDate ? new Date(t.createdDate).toLocaleString() : '-'}</p>
            <p><strong>Prev. solu√ß√£o:</strong> ${prev ? prev.toLocaleDateString() : '-'}</p>
            <div class="descricaoCompleta"><strong>Descri√ß√£o</strong><br>${descr}</div>
            <div class="modalActions"><button class="btnGray" id="ticketCloseBtn">Fechar</button></div>`;
        ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
        box.querySelector('#ticketCloseBtn').addEventListener('click', close);
    }
    async function openTicketById(id){
        try{
            renderLoading(id);
            const r = await fetch(`/api/tickets/${id}`);
            if(!r.ok){
                const err = await r.json();
                const ov = ensureOverlay();
                ov.querySelector('.modalBox').innerHTML = `<h3>Ticket #${id}</h3><p>${err.error || 'N√£o foi poss√≠vel carregar os dados.'}</p><div class="modalActions"><button class="btnGray" id="ticketCloseBtn">Fechar</button></div>`;
                ov.querySelector('#ticketCloseBtn').addEventListener('click', close);
                return;
            }
            const t = await r.json();
            renderTicket(t);
        }catch(err){
            const ov = ensureOverlay();
            ov.querySelector('.modalBox').innerHTML = `<h3>Ticket #${id}</h3><p>Erro ao conectar.</p><div class="modalActions"><button class="btnGray" id="ticketCloseBtn">Fechar</button></div>`;
            ov.querySelector('#ticketCloseBtn').addEventListener('click', close);
        }
    }
    window.openTicketById = openTicketById;

    // Gatilhos de clique
    document.addEventListener('click', (e)=>{
        const ticketCard = e.target.closest('.ticket');
        if(ticketCard && ticketCard.dataset.ticketId){
            openTicketById(ticketCard.dataset.ticketId);
            return;
        }
        const badge = e.target.closest('.legendTicketBadge');
        if(!badge) return;
        e.stopPropagation();
        const digits = (badge.textContent||'').replace(/\D/g,'');
        if(digits) openTicketById(digits);
    });
})();
</script>

<script>
(function(){
    const STORAGE_VIEW = 'kanban.view';
    const STORAGE_OWNER = 'kanban.owner';

    function getView(){ return localStorage.getItem(STORAGE_VIEW) || 'geral'; }
    function getOwner(){ return localStorage.getItem(STORAGE_OWNER) || ''; }
    function setOwner(v){ localStorage.setItem(STORAGE_OWNER, v); window.location.reload(); }

    function ensureControls(){
        const actions = document.querySelector('.acoes'); if(!actions) return;
        if (!document.getElementById('kanbanGeralBtn')){
            const a = document.createElement('button');
            a.id='kanbanGeralBtn'; a.className='btnGhost sm'; a.title='Kanban Geral'; a.textContent='üß© Geral';
            a.addEventListener('click', ()=> { localStorage.setItem(STORAGE_VIEW,'geral'); window.location.href='/'; });
            actions.insertBefore(a, document.getElementById('logoutBtn'));
        }
        if (!document.getElementById('kanbanIndBtn')){
            const b = document.createElement('button');
            b.id='kanbanIndBtn'; b.className='btnGhost sm'; b.title='Kanban Individual'; b.textContent='üë§ Individual';
            b.addEventListener('click', ()=> { localStorage.setItem(STORAGE_VIEW,'individual'); window.location.href='/'; });
            actions.insertBefore(b, document.getElementById('logoutBtn'));
        }
        if (!document.getElementById('kanbanOwner')){
            const wrap = document.createElement('div'); wrap.id = 'kanbanOwnerWrap'; wrap.style.display = 'none';
            const sel = document.createElement('select'); sel.id='kanbanOwner'; sel.style.cssText='min-width:160px;height:36px;border:1px solid #d1d5db;border-radius:8px;padding:0 8px;';
            sel.addEventListener('change', e=> setOwner(e.target.value));
            const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='Selecione o agente...'; sel.appendChild(opt0);
            wrap.appendChild(sel); actions.insertBefore(wrap, document.getElementById('logoutBtn'));
        }
        try{ const ev = new Event('DOMSubtreeModified'); document.querySelector('.acoes').dispatchEvent(ev); } catch {}
        updateUI();
    }

    function updateUI(){
        const v = getView();
        const g = document.getElementById('kanbanGeralBtn');
        const i = document.getElementById('kanbanIndBtn');
        const w = document.getElementById('kanbanOwnerWrap');
        if(g){ g.style.outline = v==='geral' ? '2px solid #93c5fd' : 'none'; }
        if(i){ i.style.outline = v==='individual' ? '2px solid #93c5fd' : 'none'; }
        if(w){ w.style.display = v==='individual' ? '' : 'none'; }
    }

    function updateOwnerOptionsFromTickets(tickets){
        const sel = document.getElementById('kanbanOwner'); if(!sel) return;
        const current = getOwner();
        const owners = Array.from(new Set((tickets||[]).map(t => t.owner || 'N√£o atribu√≠do'))).sort((a,b)=>a.localeCompare(b));
        const existing = Array.from(sel.options).map(o=>o.value);
        const changed = owners.length+1 !== existing.length || owners.some(o=>!existing.includes(o));
        if(changed){
            sel.innerHTML = '';
            const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='Selecione o agente...'; sel.appendChild(opt0);
            owners.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); });
        }
        sel.value = (current && owners.includes(current)) ? current : '';
    }
    window.__updateOwnerOptionsFromTickets = updateOwnerOptionsFromTickets;

    ensureControls();

    // Intercepta fetch para adicionar ?owner=... na chamada de /api/tickets
    const origFetch = window.fetch.bind(window);
    window.fetch = async function(input, init){
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        if (url.includes('/api/tickets') && !url.includes('?')) {
            if (getView() === 'individual') {
                const owner = getOwner();
                if (owner) {
                    const u = new URL(url, location.origin);
                    u.searchParams.set('owner', owner);
                    return origFetch(u.toString(), init);
                }
            }
        }
        return origFetch(input, init);
    };

    (function trySetDefaultOwner(){
        if(localStorage.getItem(STORAGE_OWNER)) return;
        const norm = (s)=> (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
        async function tryDefault(){
            const sel = document.getElementById('kanbanOwner');
            if(!sel) return;
            try{
                const r=await fetch('/api/me'); if(!r.ok) return;
                const me=await r.json();
                const uname=norm(me.username||''); if(!uname) return;
                const match = Array.from(sel.options).find(o => norm(o.value).includes(uname));
                if(match){
                    sel.value=match.value;
                    localStorage.setItem(STORAGE_OWNER, match.value);
                    if(getView()==='individual' && typeof carregarDashboard==='function'){ try{carregarDashboard();}catch{} }
                }
            }catch{}
        }
        function init(){
            const sel=document.getElementById('kanbanOwner');
            if(!sel){ setTimeout(init,400); return; }
            tryDefault();
            new MutationObserver(()=>tryDefault()).observe(sel,{childList:true});
        }
        init();
    })();
})();
</script>

<script>
(function(){
    const actions = document.querySelector('.acoes');
    if(!actions) return;
    function iconize(el){
        if(!el || el.dataset.iconized) return;
        const countNode = el.querySelector('#notifCount');
        let txt = (el.textContent||'').trim().replace(countNode ? countNode.textContent : '', '').trim();
        if(!txt) return;
        const sp = txt.indexOf(' ');
        const icon = sp > -1 ? txt.slice(0,sp) : txt;
        const label = sp > -1 ? txt.slice(sp+1) : '';
        el.innerHTML = '';
        const i = document.createElement('span'); i.className='icon'; i.setAttribute('aria-hidden','true'); i.textContent=icon; el.appendChild(i);
        const L = document.createElement('span'); L.className='label'; L.textContent = label; el.appendChild(L);
        if(countNode) el.appendChild(countNode);
        el.dataset.iconized = '1';
    }
    function scan(){ actions.querySelectorAll('a.btnGhost.sm,button.btnGhost.sm').forEach(iconize); }
    scan();
    new MutationObserver(scan).observe(actions, { childList:true, subtree:true, characterData:true });
})();
</script>

</body>
</html>